# Check the handling of "continue-after-failure".

# Check that we cancel the build immediately by default.
#
# RUN: rm -rf %t.build
# RUN: mkdir -p %t.build
# RUN: cp %s %t.build/build.ninja
# RUN: %{llbuild} ninja build --no-parallel --chdir %t.build --no-db &> %t1.out || true
# RUN: %{FileCheck} --check-prefix CHECK-DEFAULT --input-file %t1.out %s
#
# CHECK-DEFAULT: [1] echo > output-0
# CHECK-DEFAULT-NEXT: [2] echo > output-1
# CHECK-DEFAULT-NEXT: [3] false
# CHECK-DEFAULT-NOT: [4]
# CHECK-DEFAULT: stopping build due to command failures

# Check that we honor -k 2.
#
# RUN: rm -rf %t.build
# RUN: mkdir -p %t.build
# RUN: cp %s %t.build/build.ninja
# RUN: %{llbuild} ninja build --no-parallel --chdir %t.build --no-db -k 2 &> %t2.out || true
# RUN: %{FileCheck} --check-prefix CHECK-TWO --input-file %t2.out %s
#
# CHECK-TWO: [1] echo > output-0
# CHECK-TWO-NEXT: [2] echo > output-1
# CHECK-TWO-NEXT: [3] false
# CHECK-TWO: [4] echo > output-3
# CHECK-TWO-NEXT: [5] false
# CHECK-TWO-NOT: [6]
# CHECK-TWO: stopping build due to command failures

# Check that we honor -k 0.
#
# RUN: rm -rf %t.build
# RUN: mkdir -p %t.build
# RUN: cp %s %t.build/build.ninja
# RUN: %{llbuild} ninja build --no-parallel --chdir %t.build --no-db -k 0 &> %t3.out || true
# RUN: %{FileCheck} --check-prefix CHECK-UNLIMITED --input-file %t3.out %s
#
# CHECK-UNLIMITED: [1] echo > output-0
# CHECK-UNLIMITED: [21] echo > output-20
# CHECK-UNLIMITED: build had 2 command failures

rule CAT
     command = cat ${in} > ${out}
rule ECHO
     command = echo > ${out}
rule FALSE
     command = false

build output-0: ECHO
build output-1: ECHO
build output-2: FALSE
build output-3: ECHO
build output-4: FALSE
build output-5: ECHO
build output-6: ECHO
build output-7: ECHO
build output-8: ECHO
build output-9: ECHO
build output-10: ECHO
build output-11: ECHO
build output-12: ECHO
build output-13: ECHO
build output-14: ECHO
build output-15: ECHO
build output-16: ECHO
build output-17: ECHO
build output-18: ECHO
build output-19: ECHO
build output-20: ECHO

build output: CAT output-0 output-1 output-2 output-3 output-4 output-5 output-6 output-7 output-8 output-9 output-10 output-11 output-12 output-13 output-14 output-15 output-16 output-17 output-18 output-19 output-20
